<!DOCTYPE html>
<html lang="zh-hk">
<head>

  <meta charset="utf-8">
  <title>Video</title>
  <meta name="description" content="">
  <meta name="author" content="">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">

  <link rel="stylesheet" href="css/normalize.css">

</head>
<body>

	<div id="player">
		<canvas width="798" height="504"></canvas>
		<canvas width="798" height="15"></canvas>
	</div>

	Thread:
	<input type="number" value="2"/>
	<button> Start </button>


</body>

<style>
body{
	background-color: #212121;
}
div#player{
	background-color: #212121;
	margin: 50px;
	width: 798px;
	height: 504px;
}
div#player>canvas{
	border: 1px solid white;
}
</style>
<script>
var j1Lib_ajax=function(n,t,e){var r=new XMLHttpRequest;return r.open("GET",n),r.addEventListener("load",function(){200==r.status?t(r):e(r)}),r.addEventListener("error",function(){e(r)}),r};
var j1Lib_video_ajax = function(url,callback,worker,orginal){
	var url_ = function(data){
		return (window.URL || window.webkitURL).createObjectURL(data);
	};
	if (orginal){
		callback(url);
	}else{
		if (worker){
			var ajax_ = new Worker("js/j1Lib_video_ajax.js");
			ajax_.postMessage({ "url": url });
			ajax_.onmessage = function(e){
				callback(url_(e.data));
			};
		}else{
			var ajax_ = j1Lib_ajax(url,function(data){
				callback(url_(data.response));		
			},function(){			
			});
			ajax_.responseType = 'blob';
			ajax_.send();		
		}
	}	
};
var j1Lib_video = function(canvas,control,thread,worker){	
	var this_ = this;
	var w = canvas.width;
	var h = canvas.height;
	canvas.addEventListener('click', function(){		
		if (playing.paused){
			playing.play();
		}else{
			playing.pause();
		}
	});
	canvas = canvas.getContext("2d");
	control.setVideo(this);
	var title = null;	
	var video = [];
	var video_ = function(url){
		var video__ = document.createElement('video');	
		video__.src = url;
		video__.addEventListener('play', function(){
			if (playing=this){
				var this__ = this;				
				play_ = setInterval(function(){
					canvas.drawImage(this__,0,0,w,h);
					control.setProgress(playing_i,playing.currentTime);
				},60);
			}			
		});
		video__.addEventListener('pause', function(){
			if (playing=this){
				clearInterval(play_);
			}
		});
		video__.addEventListener('ended', function(){			
			if (playing=this){
				clearInterval(play_);
				var i = video.indexOf(this);
				play(video[i+1]);
			}
		});
		video__.addEventListener('loadedmetadata', function(){
			var i = video.indexOf(this);
			control.setBuffered(i);
		});
		return video__;
	};
	var reset = function(){
		canvas.clearRect(0,0,w,h);
	};
	var play_ = null;
	var playing = null;
	var playing_i = null;
	var play = function(video__){
		playing = video__;
		playing_i = video.indexOf(video__);
		video__.play();
	};
	var src = "";
	this.src ="";
	Object.defineProperty(this, "src", {
		get: function() {
			return src;
		},
		set: function(src_) {
			src = src_;
			j1Lib_ajax(src_+".json",function(data){
				data = JSON.parse(data.response);
				title = data.title;
				for (var i = 0 ; i<data.video.part ; i++){				
					video.push(data.video.server.replace("%server%",location.hostname)+"_"+i+"."+data.video.format);
				}
				buffer_(function(){
					play(video[0]);
				});
				this_.duration=data.length;
				this_.part=data.video.part;
				control.setPart(data.video.part);
				control.setLength(data.length);
			},function(){
			}).send();
		}
	});
	var buffer = function(video_index,callback){
		j1Lib_video_ajax(video[video_index],function(data){			
			video[video_index]=video_(data);
			callback();
		},worker,video_index==0);
	};	
	var pool = 0;	
	var thread_ = function(){
		buffer(pool++,function(){			
			if (pool < video.length){
				thread_();				
			}
		});
	};
	var buffer_ = function(callback){
		buffer(pool++,function(){
			callback();
			for (var i=0;i<thread;i++){	
				thread_();
			}
		});		
	};
	this.pause = function(){
		playing.pause();
	};
	this.play = function(){
		playing.play();
	};
	this.playAt = function(part,second){
		if (typeof video[part] === "object"){
			playing.pause();
			play(video[part]);
			playing.currentTime=second;
		}
	};
	this.duration = "";
	this.part = 0;
};
var j1Lib_video_control = function(canvas){	
	var w = canvas.width;
	var h = canvas.height;
	var load = "rgba(255,255,255,0.5)";
	var unload = "rgba(33,33,33,0.5)";	
	canvas.addEventListener('click', function(){		
		var length_ = length/w*event.layerX;
		player.playAt(parseInt(length_ / 60, 10),parseInt(length_%60,0));
	});
	canvas = canvas.getContext("2d");
	this.reset = function(){
		var size = w/(part.length+1);
		for (var i = 0 ; i<part.length;i++){
			canvas.fillStyle = part[i] || unload;
			var start = parseInt(i*size,0);
			var end = parseInt((i+1)*size,0);
			canvas.fillRect(start,0,end,h);
		}
	};
	var length=0;
	var part=[];
	this.setBuffered = function(i){
		part[i] = load;
		this.reset();
	};
	this.setPart = function(part_){
		for (var i = 0 ; i<part_;i++){
			part.push(unload);
		}
		this.reset();
	};
	this.setLength = function(length_){
		length = length_;
	};
	var duration = 0;
	this.setProgress = function(block,second){
		//canvas.fillStyle = "red";
		duration = w/length*block*60+second;
		
		//canvas.fillRect(start,0,start+2,h);
	};
	var player=null;
	this.setVideo = function(videoplayer){		
		player = videoplayer;
	};
};

document.getElementsByTagName("button")[0].addEventListener('click', function(){
	video_player_control = new j1Lib_video_control(document.getElementById("player").getElementsByTagName("canvas")[1]);
	var canvas = document.getElementById("player").getElementsByTagName("canvas")[0];
	var thread = document.getElementsByTagName("input")[0].value || 2;
	video_player = new j1Lib_video(canvas,video_player_control,thread,true);
	video_player.src="01";
});

document.addEventListener("DOMContentLoaded", function(event) {
	
});
</script>
</html>
