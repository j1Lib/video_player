!function(){document.addEventListener("DOMContentLoaded",function(){for(var e=document.getElementsByTagName("j1Lib_video"),t=function(e){!function(t,n){for(var o=0,r=0;t-r;r++)!function(t){var n=o+t;e.controls.fillStyle="white",e.controls.fillRect(o,0,t,15),o=n}(n/e.length*e.controls_length[r])}(e.controls_length.length,e.w)},n=function(e,t){return c((window.URL||window.webkitURL).createObjectURL(e),!0,t)},o=function(e,t,o,r){if(r.acao)if(r.worker){var i=new Worker("js/j1Lib_video_ajax_worker.min.js");i.postMessage({url:e}),i.onmessage=function(e){t(n(e.data,r))}}else{var i=j1Lib_ajax(e,function(e){t(n(e.response,r))},o);i.responseType="blob",i.send()}else{var i=c(e,!0,r);i.muted=!0,i.play(),i.addEventListener("progress",function(e){if(e.stopPropagation(),this.buffered.length){var t=this.buffered.end(0)/this.duration*100;t>=100?this.removeEventListener("progress",arguments.callee):this.currentTime=this.buffered.end(0)}}),i.addEventListener("ended",function(e){this.removeEventListener("ended",arguments.callee),e.stopPropagation(),t(i),i.muted=!1,i.currentTime=0})}},r=function(e,t){t.buffing++,t.e.buffered()?CustomEvent&&t.e.dispatchEvent(new CustomEvent("buffered",null)):t._video[e]&&"object"!=typeof t._video[e]&&e<=t._video.length&&o(t._video[e],function(n){t._video[e]=n,r(t.buffing,t)},function(){u("影片資源已過期。",!0,t)},t)},i=function(e,t){if(e)clearInterval(t.rendering),t.ctx.globalCompositeOperation="copy",t.rendering=setInterval(function(){t.ctx.drawImage(t.video,0,0,t.w,t.h)},t.fps),t.video.play(),CustomEvent&&t.e.dispatchEvent(new CustomEvent("play",null)),"object"==typeof t.controls&&(t._controls.style.display="none",t.controls_current.style.display="none");else if(t.video.pause(),clearInterval(t.rendering),t.ctx.globalCompositeOperation="source-over",u(t.title,!1,t),CustomEvent&&t.e.dispatchEvent(new CustomEvent("pause",null)),"object"==typeof t.controls){for(var n=t.video.currentTime,o=1;t.video_index>=o;o++)n+=t.controls_length[o-1];var r=t.w/t.length*n;t._controls.style.display="block",t.controls_current.style.display="block",t.controls_current.style.width=r+"px",t.controls_current.innerHTML=a(n)+"/"+a(t.length)}},l=function(e){return 10>e?"0"+e:e},a=function(e){return l(parseInt(e/60,0))+":"+l(parseInt(e,0)%60)},s=function(e,t){var n=e._video[t];e.video=n,e.video_index=t,n.addEventListener("ended",function(n){this.removeEventListener("ended",arguments.callee),n.stopPropagation(),this==e.video&&(clearInterval(e.rendering),"object"==typeof e._video[++t]?s(e,t):e.e.buffered()?u("影片資源已過期。",!0,e):u("影片資源緩存中……",!0,e))}),i(!0,e)},c=function(e,n,o){var r=document.createElement("video");return r.src=e,n?r.preload="auto":r.preload="metadata",r.autoplay="",r.addEventListener("loadedmetadata",function(e){this.removeEventListener("loadedmetadata",arguments.callee),e.stopPropagation(),o.controls_length.push(this.duration),"object"==typeof o.controls&&t(o)}),r},d=function(e,t,n,o,r,i){var l=t[e++];l?l.hasAttribute("src")?(u("處理影片資源 #"+e+"……",r,i),j1Lib_ajax(l.getAttribute("src"),function(l){try{n(JSON.parse(l.response))}catch(a){d(e,t,n,o,r,i)}},function(){d(e,t,n,o,r,i)}).send()):d(e,t,n,o,r,i):o()},u=function(e,t,n){var o=n.w,r=n.h;n.ctx.fillStyle="rgba(33,33,33,0.8)",n.ctx.fillRect(0,0,o,r),n.ctx.font="15px 微軟正黑體",n.ctx.fillStyle="white",t?(n.ctx.textAlign="center",o/=2,r/=2):(n.ctx.textAlign="left",o=50,r=50),n.ctx.fillText(e,o,r)},f=0;e.length-f;f++)!function(e){var n={e:null,w:0,h:0,ctx:null,title:null,length:0,video:null,_video:[],video_index:0,rendering:null,thread:0,buffing:1,worker:!0,acao:!0,controls:null,_controls:null,controls_current:null,controls_length:[],fps:60,autoplay:!1};n.e=e,e.style.display="block",e.style.position="absolute",e.hasAttribute("thread")?n.thread=parseInt(e.getAttribute("thread")):n.thread=3,n.worker=e.hasAttribute("worker"),e.hasAttribute("crossorigin")&&"bypass"==e.getAttribute("crossorigin")?n.acao=!1:n.acao=!0,e.hasAttribute("fps")?n.fps=parseInt(e.getAttribute("fps")):n.fps=60,n.autoplay=e.hasAttribute("autoplay");var o=document.createElement("canvas");if(o.style.transform="translateZ(0)",n.ctx=o.getContext("2d"),e.appendChild(o),e.hasAttribute("controls")){var l=document.createElement("canvas");n.controls=l.getContext("2d"),l.style.display="none",l.style.position="absolute",l.style.bottom="0px",l.style.left="0px",n.controls.globalCompositeOperation="copy",l.style.transform="translateZ(0)",n._controls=l,l.addEventListener("click",function(e){e.stopPropagation(),function(e,t){for(var o=0,r=0;t-o&&(r=n.controls_length[o],!(r>e));o++)e-=n.controls_length[o];if(r>e){u("影片資源緩存中……",!0,n);var i=n.video;s(n,o),n.video.currentTime=e,i.currentTime=i.duration}}(n.length/n.w*e.offsetX,n.controls_length.length)}),e.appendChild(l);var a=document.createElement("div");a.style.backgroundColor="#F44336",a.style.display="none",a.style.position="absolute",a.style.bottom="0px",a.style.left="0px",a.style.width="0px",a.style.fontSize="0.5em",a.style.paddingLeft="1em",n.controls_current=a,e.appendChild(a)}var f=function(){n.w=e.getAttribute("width")||100,n.h=e.getAttribute("height")||100,e.style.width=n.w+"px",e.style.height=n.h+"px",o.width=n.w,o.height=n.h,o.style.display="block","object"==typeof n.controls&&(l.width=n.w,l.height="15",l.style.opacity="0.2",l.style.zIndex="1",a.style.height=l.height+"px",t(n))};window.addEventListener("resize",f),f();var p=e.getElementsByTagName("source");u("j1Lib_Video 1.0",!0,n),p.length?d(0,p,function(t){n.title=t.title,n.length=t.length,u(t.title,!0,n);var o=t.video.server||"",l=t.video.format||"",a=t.video.part;if("object"==typeof a&&(a=a.length-1),a){for(var d=0;a>=d;d++)!function(e){"object"==typeof t.video.part&&(e=t.video.part[d]),n._video.push(o+e+l)}(d);var f=c(n._video[0],!0,n);n._video[0]=f,e.addEventListener("click",function(e){e.stopPropagation(),n.video?i(n.video.paused,n):n.autoplay||(u("影片資源緩存中……",!0,n),n.autoplay=!0,s(n,0))}),n.autoplay&&s(n,0),e.pause=function(){i(!1,n)},e.play=function(){i(!0,n)},e.paused=function(){return n.video.paused},e.buffered=function(){return n.buffing==n._video.length+n.thread},n.buffing=1;for(var d=1;d<=n.thread;d++)!function(e){r(e,n)}(d)}else u("空白影片資源。",!0,n)},function(){u("影片資源已過期。",!0,n)},!0,n):u("無效影片資源。",!0,n)}(e[f])})}();