document.addEventListener("DOMContentLoaded",function(){for(var e=document.getElementsByTagName("j1Lib_video"),t=function(e){!function(t,n){for(var o=0,i=0;t-i;i++)!function(t){var n=o+t;e.controls.fillStyle="white",e.controls.fillRect(o,0,t,15),o=n}(n/e.length*e.controls_length[i])}(e.controls_length.length,e.w)},n=function(e,t){return a((window.URL||window.webkitURL).createObjectURL(e),!0,t)},o=function(e,t,o,i){if(i.acao)if(i.worker){var r=new Worker("js/j1Lib_video_ajax_worker.min.js");r.postMessage({url:e}),r.onmessage=function(e){t(n(e.data,i))}}else{var r=j1Lib_ajax(e,function(e){t(n(e.response,i))},o);r.responseType="blob",r.send()}else{var r=a(e,!0,i);r.muted=!0,r.play(),r.addEventListener("progress",function(e){if(e.stopPropagation(),this.buffered.length){var t=this.buffered.end(0)/this.duration*100;t>=100?this.removeEventListener("progress",arguments.callee):this.currentTime=this.buffered.end(0)}}),r.addEventListener("ended",function(e){this.removeEventListener("ended",arguments.callee),e.stopPropagation(),t(r),r.muted=!1,r.currentTime=0})}},i=function(e,t){t.buffing++,t.e.buffered()?CustomEvent&&t.e.dispatchEvent(new CustomEvent("buffered",null)):t._video[e]&&"object"!=typeof t._video[e]&&e<=t._video.length&&o(t._video[e],function(n){t._video[e]=n,i(t.buffing,t)},function(){d("影片資源已過期。",!0,t)},t)},r=function(e,t){if(e)clearInterval(t.rendering),t.rendering=setInterval(function(){t.ctx.drawImage(t.video,0,0,t.w,t.h)},t.fps),t.video.play(),CustomEvent&&t.e.dispatchEvent(new CustomEvent("play",null)),"object"==typeof t.controls&&(t._controls.style.display="none",t.controls_current.style.display="none");else if(t.video.pause(),clearInterval(t.rendering),d(t.title,!1,t),CustomEvent&&t.e.dispatchEvent(new CustomEvent("pause",null)),"object"==typeof t.controls){for(var n=t.video.currentTime,o=1;t.video_index>=o;o++)n+=t.controls_length[o-1];var i=t.w/t.length*n;t._controls.style.display="block",t.controls_current.style.display="block",t.controls_current.style.width=i+"px"}},l=function(e,t){var n=e._video[t];e.video=n,e.video_index=t,n.addEventListener("ended",function(n){this.removeEventListener("ended",arguments.callee),n.stopPropagation(),this==e.video&&(clearInterval(e.rendering),"object"==typeof e._video[++t]?l(e,t):e.e.buffered()?d("影片資源已過期。",!0,e):d("影片資源緩存中……",!0,e))}),r(!0,e)},a=function(e,n,o){var i=document.createElement("video");return i.src=e,n?i.preload="auto":i.preload="metadata",i.autoplay="",i.addEventListener("loadedmetadata",function(e){this.removeEventListener("loadedmetadata",arguments.callee),e.stopPropagation(),o.controls_length.push(this.duration),"object"==typeof o.controls&&t(o)}),i},s=function(e,t,n,o,i,r){var l=t[e++];l?l.hasAttribute("src")?(d("處理影片資源 #"+e+"……",i,r),j1Lib_ajax(l.getAttribute("src"),function(l){try{n(JSON.parse(l.response))}catch(a){s(e,t,n,o,i,r)}},function(){s(e,t,n,o,i,r)}).send()):s(e,t,n,o,i,r):o()},d=function(e,t,n){var o=n.w,i=n.h;n.ctx.fillStyle="rgba(33,33,33,0.8)",n.ctx.fillRect(0,0,o,i),n.ctx.font="15px 微軟正黑體",n.ctx.fillStyle="white",t?(n.ctx.textAlign="center",o/=2,i/=2):(n.ctx.textAlign="left",o=50,i=50),n.ctx.fillText(e,o,i)},c=0;e.length-c;c++)!function(e){var n={e:null,w:0,h:0,ctx:null,title:null,length:0,video:null,_video:[],video_index:0,rendering:null,thread:0,buffing:1,worker:!0,acao:!0,controls:null,_controls:null,controls_current:null,controls_length:[],fps:60,autoplay:!1};n.e=e,e.style.display="block",e.style.position="absolute",e.hasAttribute("thread")?n.thread=parseInt(e.getAttribute("thread")):n.thread=3,n.worker=e.hasAttribute("worker"),e.hasAttribute("crossorigin")&&"bypass"==e.getAttribute("crossorigin")?n.acao=!1:n.acao=!0,e.hasAttribute("fps")?n.fps=parseInt(e.getAttribute("fps")):n.fps=60,n.autoplay=e.hasAttribute("autoplay");var o=document.createElement("canvas");if(n.ctx=o.getContext("2d"),e.appendChild(o),e.hasAttribute("controls")){var c=document.createElement("canvas");n.controls=c.getContext("2d"),c.style.display="none",c.style.position="absolute",c.style.bottom="0px",c.style.left="0px",n._controls=c,c.addEventListener("click",function(e){e.stopPropagation(),d("影片資源緩存中……",!0,n),function(e,t){for(var o=0,i=0;t-o&&(i=n.controls_length[o],!(i>e));o++)e-=n.controls_length[o];if(i>e){var r=n.video;l(n,o),n.video.currentTime=e,r.currentTime=r.duration}}(n.length/n.w*e.offsetX,n.controls_length.length)}),e.appendChild(c);var u=document.createElement("div");u.style.backgroundColor="#F44336",u.style.display="none",u.style.position="absolute",u.style.bottom="0px",u.style.left="0px",u.style.width="0px",n.controls_current=u,e.appendChild(u)}var f=function(){n.w=e.getAttribute("width")||100,n.h=e.getAttribute("height")||100,e.style.width=n.w+"px",e.style.height=n.h+"px",o.width=n.w,o.height=n.h,o.style.display="block","object"==typeof n.controls&&(c.width=n.w,c.height="15",c.style.opacity="0.2",c.style.zIndex="1",u.style.height=c.height+"px",t(n))};window.addEventListener("resize",f),f();var v=e.getElementsByTagName("source");d("j1Lib_Video 1.0",!0,n),v.length?s(0,v,function(t){n.title=t.title,n.length=t.length,d(t.title,!0,n);var o=t.video.server||"",s=t.video.format||"",c=t.video.part;if("object"==typeof c&&(c=c.length-1),c){for(var u=0;c>=u;u++)!function(e){"object"==typeof t.video.part&&(e=t.video.part[u]),n._video.push(o+e+s)}(u);var f=a(n._video[0],!0,n);n._video[0]=f,e.addEventListener("click",function(e){e.stopPropagation(),n.video?r(n.video.paused,n):n.autoplay||(d("影片資源緩存中……",!0,n),n.autoplay=!0,l(n,0))}),n.autoplay&&l(n,0),e.pause=function(){r(!1,n)},e.play=function(){r(!0,n)},e.paused=function(){return n.video.paused},e.buffered=function(){return n.buffing==n._video.length+n.thread},n.buffing=1;for(var u=1;u<=n.thread;u++)!function(e){i(e,n)}(u)}else d("空白影片資源。",!0,n)},function(){d("影片資源已過期。",!0,n)},!0,n):d("無效影片資源。",!0,n)}(e[c])});